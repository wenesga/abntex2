name: Auto Commit with Gemini

on:
  push:
    paths:
      - '**.tex'
      - '**.md'
      - '**.txt'
      - '**.sty'
      - '**.cls'
      - '**.bib'

permissions:
  contents: write

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create diff file (safe)
        id: make_diff
        run: |
          set -e
          # tenta diff entre HEAD~1 e HEAD; se não existir (primeiro commit), usa diff atual
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            git diff --no-color HEAD~1 HEAD > diff.txt || true
          else
            git diff --no-color > diff.txt || true
          fi
          # Limita o tamanho para evitar payloads grandes (20 KB)
          head -c 20000 diff.txt > diff_limited.txt || true
          wc -c diff_limited.txt

      - name: Build Gemini request JSON
        run: |
          jq -Rs '{contents:[{parts:[{text: .}]}]}' diff_limited.txt > payload.json
          echo "Payload size:"
          wc -c payload.json

      - name: Call Gemini API to create commit message
        id: gemini
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          if [ -z "$GEMINI_KEY" ]; then
            echo "Missing GEMINI_API_KEY secret" >&2
            exit 1
          fi

          RESPONSE_FILE=response.json
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: ${GEMINI_KEY}" \
            --data-binary @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent" \
            -o "$RESPONSE_FILE"

          # Extrai a primeira mensagem gerada
          COMMIT_MSG=$(jq -r '.candidates[0].content.parts[0].text // empty' "$RESPONSE_FILE" | sed -n '1,6p' | head -c 200)
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Apply auto commit (only if message present)
        run: |
          set -e
          MSG="${{ steps.gemini.outputs.commit_message }}"
          if [ -z "$MSG" ]; then
            echo "No message generated by Gemini — skipping automated commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "$MSG" || { echo "Nothing to commit"; exit 0; }
          git push origin HEAD
